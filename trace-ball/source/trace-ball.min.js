'use strict';class Game{initialize(){Engine.Text.setFont('Multicolore'),Engine.Text.setColorRGBA(0.1,0.1,0.1,1),Engine.Text.setShadowColorRGBA(0,0,0,0.7),Engine.Text.setShadowBlur(4),Engine.Canvas.setSize(640,480),Engine.Canvas.showCursor(!1),this.player=new Player(0,0,this.assets),this.enemy=new Enemy(640,480,this.assets)}update(e){this.player.update(this.enemy,e),this.enemy.update(this.player,e),Camera.update(e)}draw(e){Engine.Effect.setCurrent(this.assets.chromatic),Engine.Canvas.clearRGBA(0.9,0.9,0.9,1);let t=Engine.Canvas.getWidth()/2,n=Engine.Canvas.getHeight()/2;this.assets.texBack.draw(t,n),this.enemy.draw(e),this.player.draw(e)}}var Camera={update:function(e){if(!(0>=Camera._.timer)){let t=new Engine.Vector2().copy(Camera._.shakeMin),n=new Engine.Vector2().copy(Camera._.shakeMax),o=Engine.Utility.randomRangeInteger(t.x,n.x),d=Engine.Utility.randomRangeInteger(t.y,n.y);Engine.Canvas.setDrawOffset(o,d),Camera._.timer-=e,0>=Camera._.timer&&Engine.Canvas.setDrawOffset(0,0)}},shake:function(e,t,n,o,d){Camera._.shakeMin=new Engine.Vector2(t,n),Camera._.shakeMax=new Engine.Vector2(o,d),Camera._.timer=e},_:{shakeMin:null,shakeMax:null,timer:0}};class Player{constructor(e,t,n){this.IMMUNE_TIME=1.25,this.RADIUS=16,this.TEXT_FLASH_TIME=0.15,this.MIN_SHAKE=-15,this.MAX_SHAKE=15,this.SHAKE_TIME=0.3,this.GHOSTS=4,this.RIGIDNESS=100,this.SCALE=0.4,this.pos=new Engine.Vector2(e,t),this.lastPos=new Engine.Vector2(e,t),this.angle=0,this.distance=0,this.lives=3,this.state='idle',this.texture=n.texEntity,this.sndHit=n.sndPlayerHit,this.anmIdle=n.anmPlayerIdle,this.anmHit=n.anmPlayerHit,this.anmDead=n.anmPlayerDead,this.immune=!1,this.immuneTimer=0,this.immuneFlash=!1,this.textFlashTimer=0,this.scoreTime=0}takeDamage(){let e=this.MIN_SHAKE,t=this.MAX_SHAKE,n=this.SHAKE_TIME;Camera.shake(n,e,e,t,t),this.sndHit.play(),this.anmHit.reset(),this.state='hit',this.immune=!0,this.immuneTimer=this.IMMUNE_TIME,this.textFlashTimer=this.TEXT_FLASH_TIME,this.lives--,0>=this.lives&&(this.state='dead')}updateImmune(e){let t=this.immuneTimer/300,n=2*t,o=30*this.immuneTimer,d=[0,0];d[0]=Engine.Utility.sinInRange(o,-n,n),d[1]=Engine.Utility.sinInRange(o,-t,t),Engine.Effect.setCurrentUniform('pulse',d),this.immuneFlash=!this.immuneFlash,this.immuneTimer-=e,0>=this.immuneTimer&&(Engine.Effect.setCurrentUniform('pulse',[0,0]),this.immune=!1,this.immuneFlash=!1),this.anmHit.update(e)}update(e,t){if(this.distance=0,'dead'===this.state)this.anmDead.update(t);else{'hit'===this.state&&this.anmHit.isDone()&&(this.state='idle');let n=Engine.Canvas.getWidth(),o=Engine.Canvas.getHeight();if(this.lastPos.copy(this.pos),this.pos=Engine.Event.getCursorPosition(),this.pos.x=Engine.Utility.clamp(this.pos.x,0,n),this.pos.y=Engine.Utility.clamp(this.pos.y,0,o),!this.lastPos.equalTo(this.pos)){let d=this.pos.subVector(this.lastPos).normalize();this.distance=this.pos.subVector(this.lastPos).absolute().length(),this.angle=Math.atan2(d.y,d.x)}if(this.immune)this.updateImmune(t);else{let d=this.pos.x,l=this.pos.y;Engine.Collision.circleAndCircle(d,l,this.RADIUS,e.pos.x,e.pos.y,e.RADIUS)&&this.takeDamage()}this.scoreTime+=t}}drawUIElements(e){let t='Time: '+this.scoreTime.toFixed(2),n='Lives: '+this.lives;0>=this.textFlashTimer?Engine.Text.setColorRGBA(0.1,0.1,0.1,1):(Engine.Text.setColorRGBA(1,1,1,1),this.textFlashTimer-=e);Engine.Text.drawFill(8,8,t+'\n'+n)}drawGhostingTrail(e,t,n,o){var d=new Engine.Vector2().copy(this.lastPos);for(let _=0;_<o;_++){let f=(this.pos.x+this.lastPos.x)/2,m=(this.pos.y+this.lastPos.y)/2;this.texture.setColorRGBA(1,1,1,1/(o+1)),this.texture.drawAnimated(f,m,e,t,n,this.angle),d.assign(f,m)}this.texture.setColorRGBA(1,1,1,1)}draw(e){if(!this.anmDead.isDone()){if(this.drawUIElements(e),'dead'!==this.state&&this.immuneFlash)return;switch(this.state){case'idle':var t=this.anmIdle;break;case'hit':var t=this.anmHit;break;case'dead':var t=this.anmDead;}let m=this.distance/this.RIGIDNESS,u=this.distance/this.RIGIDNESS/15;var n=this.SCALE+Engine.Utility.clamp(m,0,1.5),o=this.SCALE-Engine.Utility.clamp(u,0,0.1),d=this.GHOSTS,l=this.pos.x,_=this.pos.y,f=this.angle;'dead'!==this.state&&this.drawGhostingTrail(t,n,o,d),this.texture.drawAnimated(l,_,t,n,o,f)}}}class Enemy{constructor(e,t,n){this.RADIUS=16,this.SPEED=400,this.ACCELERATION=10,this.SCALE=0.4,this.GHOSTS=4,this.pos=new Engine.Vector2(e,t),this.lastPos=new Engine.Vector2(e,t),this.angle=0,this.texture=n.texEntity,this.anmIdle=n.anmEnemyIdle}update(e,t){if(this.lastPos.copy(this.pos),this.SPEED+=t*this.ACCELERATION,!Engine.Collision.circleAndCircle(this.pos.x,this.pos.y,this.RADIUS,e.pos.x,e.pos.y,e.RADIUS)){let n=e.pos.subVector(this.lastPos).normalize();this.pos.copy(this.lastPos.addVector(n.mulScalar(t*this.SPEED)))}}drawGhostingTrail(e,t,n){var o=new Engine.Vector2().copy(this.lastPos);for(let l=0;l<n;l++){let _=(this.pos.x+this.lastPos.x)/2,f=(this.pos.y+this.lastPos.y)/2;this.texture.setColorRGBA(1,1,1,1/(n+1)),this.texture.drawAnimated(_,f,this.anmIdle,e,t,this.angle),o.assign(_,f)}this.texture.setColorRGBA(1,1,1,1)}draw(e){const t=2*Math.PI;this.anmIdle.update(e),this.angle+=0.08,this.angle>t&&(this.angle-=t);let n=this.SCALE,o=this.SCALE,d=this.GHOSTS,l=this.pos.x,_=this.pos.y,f=this.angle;this.drawGhostingTrail(n,o,d),this.texture.drawAnimated(l,_,this.anmIdle,n,o,f)}}var Engine={};Engine.main=function(){Engine.Canvas._.initialize(),Engine.Effect._.initialize(),Engine.Event._.initialize(),Engine.Shape._.initialize(),Engine.Text._.initialize(),Engine.Mixer._.initialize(),Engine.Canvas.setSize(640,480),Engine.Canvas.setRefreshRate(60),Engine.Canvas._.text.fillStyle='rgb(0, 0, 0, 1)',Engine.Canvas._.text.fillRect(0,0,640,480);Promise.all([Engine.AssetLoader.loadAssetPackage('engine','assets/assets.engine.json'),Engine.AssetLoader.loadAssetPackage('game','assets/assets.game.json')]).then(Engine.setupGame)},Engine.setupGame=function(){Engine.game=new Game,Engine.Assets=Engine.AssetLoader.getPackage('engine'),Engine.game.assets=Engine.AssetLoader.getPackage('game'),Engine.game.initialize(),Engine.runGame()},Engine.runGame=function(){Engine.Effect._.begin(),Engine.game.update(Engine.Canvas._.dt),Engine.game.draw(Engine.Canvas._.dt),Engine.Effect._.end();let e=1e3/Engine.Canvas._.fps;window.setTimeout(Engine.runGame,e)},window.addEventListener?window.addEventListener('load',Engine.main):window.attachEvent&&window.attachEvent('onload',Engine.main),Engine.Utility={loadFile:function(e,t='text'){return new Promise(function(n){var d=new XMLHttpRequest;d.responseType=t,d.open('GET',e,!0),d.onload=function(){n(200===d.status?d.response:null)},d.send()})},sinInRange:function(e,t,n){let o=(n-t)/2;return t+o+Math.sin(e)*o},clamp:function(e,t,n){if(e<t)return t;return e>n?n:e},randomRangeInteger:function(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t+1-e))+e},randomRangeNumber:function(e,t){return Math.random()*(t+1-e)+e}},Engine.Vector2=class{constructor(e=0,t=0){this.x=e,this.y=t}assign(e,t){return this.x=e,this.y=t,this}copy(e){return this.x=e.x,this.y=e.y,this}addVector(e){return new Engine.Vector2(this.x+e.x,this.y+e.y)}addScalar(e){return new Engine.Vector2(this.x+e,this.y+e)}subVector(e){return new Engine.Vector2(this.x-e.x,this.y-e.y)}subScalar(e){return new Engine.Vector2(this.x-e,this.y-e)}divVector(e){return new Engine.Vector2(this.x/e.x,this.y-e.y)}divScalar(e){return new Engine.Vector2(this.x/e,this.y/e)}mulVector(e){return new Engine.Vector2(this.x*e.x,this.y*e.y)}mulScalar(e){return new Engine.Vector2(this.x*e,this.y*e)}assignAddVector(e){return this.copy(this.addVector(e))}assignAddScalar(e){return this.copy(this.addScalar(e))}assignSubScalar(e){return this.copy(this.subVector(e))}assignSubScalar(e){return this.copy(this.subScalar(e))}assignDivVector(e){return this.copy(this.divVector(e))}assignDivScalar(e){return this.copy(this.divScalar(e))}assignMulVector(e){return this.copy(this.mulVector(e))}assignMulScalar(e){return this.copy(this.mulScalar(e))}normalize(){return new Engine.Vector2(this.x,this.y).divScalar(this.length())}assignNormalize(){return this.copy(this.normalize())}rotate(e){let t=Math.cos(e),n=Math.sin(e);return new Engine.Vector2(this.x*t-this.y*n,this.x*n+this.y*t)}assignRotate(e){return this.copy(this.rotate(e))}absolute(){return new Engine.Vector2(Math.abs(this.x),Math.abs(this.y))}assignAbsolute(){return this.copy(this.absolute())}dot(e){return this.x*e.x+this.y*e.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}equalTo(e){return this.x===e.x&&this.y===e.y}},Engine.Matrix3=class{constructor(e=1,t=0,n=0,o=0,d=1,l=0,_=0,f=0,m=1){this.elements=[e,o,_,t,d,f,n,l,m]}assign(e,t,n,o,d,l,_,f,m){return this.elements=[e,o,_,t,d,f,n,l,m],this}copy(e){return this.elements=[...e.elements],this}assignIdentity(){this.elements=[1,0,0,0,1,0,0,0,1]}mulMatrix(e){let t=e.elements,n=this.elements;return new Engine.Matrix3(n[0]*t[0]+n[3]*t[1]+n[6]*t[2],n[0]*t[3]+n[3]*t[4]+n[6]*t[5],n[0]*t[6]+n[3]*t[7]+n[6]*t[8],n[1]*t[0]+n[4]*t[1]+n[7]*t[2],n[1]*t[3]+n[4]*t[4]+n[7]*t[5],n[1]*t[6]+n[4]*t[7]+n[7]*t[8],n[2]*t[0]+n[5]*t[1]+n[8]*t[2],n[2]*t[3]+n[5]*t[4]+n[8]*t[5],n[2]*t[6]+n[5]*t[7]+n[8]*t[8])}assignMultiply(e){return this.copy(this.mulMatrix(e))}translate(e,t){let n=new Engine.Matrix3().copy(this),o=n.elements;return o[6]+=e*o[0]+t*o[3],o[7]+=e*o[1]+t*o[4],o[8]+=e*o[2]+t*o[5],n}assignTranslate(e,t){return this.copy(this.translate(e,t))}scale(e,t){let n=new Engine.Matrix3().copy(this),o=n.elements;return o[0]*=e,o[1]*=e,o[2]*=e,o[3]*=t,o[4]*=t,o[5]*=t,n}assignScale(e,t){return this.copy(this.scale(e,t))}rotate(e){let t=new Engine.Matrix3().copy(this),n=t.elements,o=Math.cos(e),d=Math.sin(e),l=n[0],_=n[1],f=n[2],m=n[3],u=n[4],C=n[5];return n[0]=o*l+d*m,n[1]=o*_+d*u,n[2]=o*f+d*C,n[3]=-d*l+o*m,n[4]=-d*_+o*u,n[5]=-d*f+o*C,t}assignRotate(e){return this.copy(this.rotate(e))}equalTo(e){var t=e.elements,n=this.elements;for(let o=0;9>o;o++)if(n[o]!==t[o])return!1;return!0}toFloat32Array(){return new Float32Array(this.elements)}},Engine.Event={addEventHandler:function(e,t){window.addEventListener?window.addEventListener(e,t):window.attachEvent&&window.attachEvent(e,t)},getCursorPosition:function(){return new Engine.Vector2().copy(Engine.Event._.cursor)},_:{cursor:null,initialize:function(){let e=Engine.Event._.getCursorPosition;Engine.Event.addEventHandler('mousemove',e),Engine.Event._.cursor=new Engine.Vector2},getCursorPosition:function(e){let t=Engine.Canvas._.gameCanvas.getBoundingClientRect();Engine.Event._.cursor.x=e.clientX-t.left,Engine.Event._.cursor.y=e.clientY-t.top}}},Engine.AssetLoader={loadAssetPackage:function(e,t){return new Promise(function(n){Engine.Utility.loadFile(t).then(function(d){Engine.AssetLoader._.packages[e]={},Engine.AssetLoader._.packages[e].promises=[];var l=Engine.AssetLoader._.packages[e],_=JSON.parse(d).assets;for(let m,f=0;f<_.length;f++)m=Engine.AssetLoader._.loadAsset(e,_[f]),l.promises[f]=m;Promise.all(l.promises).then(function(){n()})})})},getPackage:function(e){return Engine.AssetLoader._.packages[e]},_:{packages:{},loadAsset:function(e,t){switch(t.type){case'texture':var n=Engine.AssetLoader._.loadTexture;break;case'font':var n=Engine.AssetLoader._.loadFont;break;case'animation':var n=Engine.AssetLoader._.loadAnimation;break;case'sound':var n=Engine.AssetLoader._.loadSound;break;case'shader':var n=Engine.AssetLoader._.loadShader;break;default:return void console.error('Attempt to load unknown asset type: '+t.type);}return n(e,t)},loadTexture:function(e,t){var n=Engine.AssetLoader._.packages[e];return new Promise(function(o){var l=new Image;l.src=t.file,l.onload=function(){let _=new Engine.Texture(l);n[t.name]=_,o()}})},loadFont:function(e,t){var n=Engine.AssetLoader._.packages[e];return new Promise(function(o){n[t.name]=t.name;let l=document.createElement('style');l.innerHTML=`
        @charset "utf-8";
        @font-face
        {
          font-family: "${t.name}";
          src: url("${t.file}");
        }
        `,document.head.appendChild(l),o()})},loadAnimation:function(e,t){var n=Engine.AssetLoader._.packages[e];return new Promise(function(o){Engine.Utility.loadFile(t.file,'json').then(function(_){let f=new Engine.Animation(_);n[t.name]=f,o()})})},loadSound:function(e,t){var n=Engine.AssetLoader._.packages[e];return new Promise(function(o){Engine.Utility.loadFile(t.file,'arraybuffer').then(function(_){let f=Engine.Mixer._.context;f.decodeAudioData(_).then(function(m){let u=new Engine.Sound(m);n[t.name]=u,o()})})})},loadShader:function(e,t){var n=Engine.AssetLoader._.packages[e];return new Promise(function(o){let l=t.file+'.vert',_=t.file+'.frag';Promise.all([Engine.Utility.loadFile(l),Engine.Utility.loadFile(_)]).then(function(f){let m=f[0],u=f[1],C=new Engine.Shader(m,u);n[t.name]=C,o()})})}}},Engine.Collision={pointAndBox:function(e,t,n,o,d,l){return e<n+d&&e>n&&t<o+l&&t>o},circleAndCircle:function(e,t,n,o,d,l){let _=Math.pow(o-e,2),f=Math.pow(d-t,2),m=Math.pow(n+l,2);return _+f<m},boxAndBox:function(e,t,n,o,d,l,_,f){return e<d+_&&e+n>d&&t<l+f&&t+o>l}},Engine.Canvas={showCursor:function(e){let t=e?'default':'none';Engine.Canvas._.gameCanvas.style.cursor=t,Engine.Canvas._.textCanvas.style.cursor=t},clearRGBA:function(e=0,t=0,n=0,o=1){let d=new Engine.Color(e,t,n,o);Engine.Canvas.clear(d)},clear:function(e){Engine.Canvas._.webgl.clearColor(e.r,e.g,e.b,e.a),Engine.Canvas._.webgl.clear(Engine.Canvas._.webgl.COLOR_BUFFER_BIT);let t=Engine.Canvas._.textCanvas.width,n=Engine.Canvas._.textCanvas.height;Engine.Canvas._.text.clearRect(0,0,t,n)},setSize:function(e,t){Engine.Canvas._.container.style.width=`${e}px`,Engine.Canvas._.container.style.height=`${t}px`,Engine.Canvas._.gameCanvas.width=e,Engine.Canvas._.gameCanvas.height=t,Engine.Canvas._.textCanvas.width=e,Engine.Canvas._.textCanvas.height=t,Engine.Canvas._.webgl.viewport(0,0,e,t);let d=new Engine.Matrix3().translate(-1,1).scale(2/e,-2/t);Engine.Canvas._.worldSpace=d,Engine.Text._.restore(),Engine.Effect._.initialize(e,t)},setRefreshRate:function(e){Engine.Canvas._.dt=1/e,Engine.Canvas._.fps=e},setDrawOffset:function(e,t){Engine.Canvas._.drawOffset.assign(e,t)},getWidth:function(){return Engine.Canvas._.gameCanvas.width},getHeight:function(){return Engine.Canvas._.gameCanvas.height},_:{container:null,gameCanvas:null,webgl:null,textCanvas:null,text:null,drawOffset:null,fps:0,dt:0,worldSpace:null,initialize:function(){var e=document.getElementById('game-container');e.style.position='relative',e.style.margin='0px auto',e.style.width='800px',e.style.height='600px',Engine.Canvas._.createCanvas(e,'game-canvas'),Engine.Canvas._.createCanvas(e,'text-canvas');var t=document.getElementById('game-canvas'),n=t.getContext('webgl',{alpha:!1});if(!n&&(n=t.getContext('experimental-webgl',{alpha:!1}),!n))return void alert('WebGL is not supported in your browser!');var o=document.getElementById('text-canvas'),d=o.getContext('2d');return d?void(t.style['z-index']='0',o.style['z-index']='1',n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.enable(n.BLEND),Engine.Canvas._.container=e,Engine.Canvas._.gameCanvas=t,Engine.Canvas._.webgl=n,Engine.Canvas._.textCanvas=o,Engine.Canvas._.text=d,Engine.Canvas._.drawOffset=new Engine.Vector2):void alert('Failed to create text drawing canvas!')},createCanvas(e,t){let n=document.createElement('canvas');n.setAttribute('id',t),n.style.position='absolute',n.style.top='0px',n.style.left='0px',n.style.display='block',n.style['border-radius']='16px',e.appendChild(n)}}},Engine.Effect={setCurrentUniform:function(e,t){Engine.Effect._.currentEffect.setUniform(e,t)},setCurrent:function(e){Engine.Effect._.currentEffect=e},_:{targetTexture:null,framebuffer:null,currentEffect:null,vertexVBO:null,texCoordVBO:null,initialize:function(){let e=Engine.Canvas._.webgl,t=e.createTexture(),n=e.TEXTURE_2D,o=e.RGBA,d=Engine.Canvas.getWidth(),l=Engine.Canvas.getHeight(),_=e.UNSIGNED_BYTE;e.bindTexture(n,t),e.texImage2D(n,0,o,d,l,0,o,_,null);let f=e.CLAMP_TO_EDGE,m=e.NEAREST,u=e.NEAREST;e.texParameteri(n,e.TEXTURE_WRAP_S,f),e.texParameteri(n,e.TEXTURE_WRAP_T,f),e.texParameteri(n,e.TEXTURE_MIN_FILTER,m),e.texParameteri(n,e.TEXTURE_MAG_FILTER,u);let C=Engine.Canvas._.webgl.createFramebuffer(),A=e.COLOR_ATTACHMENT0;e.bindFramebuffer(e.FRAMEBUFFER,C),e.framebufferTexture2D(e.FRAMEBUFFER,A,n,t,0);let E=new Float32Array([-1,1,-1,-1,1,1,1,-1]),p=new Float32Array([0,1,0,0,1,1,1,0]),T=e.createBuffer(),v=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,T),e.bufferData(e.ARRAY_BUFFER,E,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,v),e.bufferData(e.ARRAY_BUFFER,p,e.STATIC_DRAW),e.deleteTexture(Engine.Effect._.targetTexture),e.deleteFramebuffer(Engine.Effect._.framebuffer),e.deleteBuffer(Engine.Effect._.vertexVBO),e.deleteBuffer(Engine.Effect._.texCoordVBO),Engine.Effect._.targetTexture=t,Engine.Effect._.framebuffer=C,Engine.Effect._.vertexVBO=T,Engine.Effect._.texCoordVBO=v},begin:function(){let e=Engine.Effect._.framebuffer,t=Engine.Canvas._.webgl;t.bindFramebuffer(t.FRAMEBUFFER,e)},end:function(){let e=Engine.Canvas._.webgl;e.bindFramebuffer(e.FRAMEBUFFER,null);let t=Engine.Effect._.currentEffect;if(null!==t)var n=t;else var n=Engine.Assets.basic;Engine.Shader.setCurrent(n);let o=Engine.Effect._.targetTexture,d=Engine.Effect._.vertexVBO,l=Engine.Effect._.texCoordVBO;e.bindBuffer(e.ARRAY_BUFFER,d),n.enableAttribute('in_vert_pos',2,!0,2,0),e.bindBuffer(e.ARRAY_BUFFER,l),n.enableAttribute('in_tex_coord',2,!0,2,0),n.setUniform('framebuffer',0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,o),e.drawArrays(e.TRIANGLE_STRIP,0,4)}}},Engine.Color=class{constructor(e=1,t=1,n=1,o=1){this.r=e,this.g=t,this.b=n,this.a=o}assign(e,t,n,o){return this.r=e,this.g=t,this.b=n,void 0!==o&&(this.a=o),this}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}equalTo(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}toArray(){return[this.r,this.g,this.b,this.a]}},Engine.Shader=class{static setCurrent(e){Engine.Canvas._.webgl.useProgram(e._.program)}static unsetCurrent(){Engine.Canvas._.webgl.useProgram(null)}constructor(e,t){var n=Engine.Canvas._.webgl;let o=function(p,T){let v=n.createShader(T);n.shaderSource(v,p),n.compileShader(v);let R=n.getShaderParameter(v,n.COMPILE_STATUS);if(R)return v;let S=n.getShaderInfoLog(v);return console.error('Failed to compile shader: '+S),null},d=o(e,n.VERTEX_SHADER),l=o(t,n.FRAGMENT_SHADER);if(!d||!l)return null;var _=n.createProgram();if(n.attachShader(_,d),n.attachShader(_,l),n.linkProgram(_),!n.getProgramParameter(_,n.LINK_STATUS)){let p=n.getProgramInfoLog(_);console.error('Failed to link shader: '+p)}n.detachShader(_,l),n.detachShader(_,d),n.deleteShader(d),n.deleteShader(l);let f=n.ACTIVE_ATTRIBUTES,m=n.ACTIVE_UNIFORMS,u=n.getProgramParameter(_,f),C=n.getProgramParameter(_,m),A={},E={};for(let p=0;p<u;p++){let T=n.getActiveAttrib(_,p),v=n.getAttribLocation(_,T.name);A[T.name]={location:v}}for(let p=0;p<C;p++){let T=n.getActiveUniform(_,p),v=n.getUniformLocation(_,T.name);E[T.name]={type:T.type,location:v}}this._={},this._.program=_,this._.attributes=A,this._.uniforms=E}enableAttribute(e,t,n,o,d){if(e in this._.attributes){let l=this._.attributes[e],_=Engine.Canvas._.webgl;o*=Float32Array.BYTES_PER_ELEMENT,d*=Float32Array.BYTES_PER_ELEMENT;let f=l.location,m=_.FLOAT;_.enableVertexAttribArray(f),_.vertexAttribPointer(f,t,m,n,o,d)}}setUniform(e,t){if(e in this._.uniforms){let n=this._.uniforms[e];var o=Engine.Canvas._.webgl,d=n.location,l=n.type;switch(l){case o.FLOAT:o.uniform1f(d,t);break;case o.FLOAT_VEC2:o.uniform2f(d,...t);break;case o.FLOAT_VEC3:o.uniform3f(d,...t);break;case o.FLOAT_VEC4:o.uniform4f(d,...t);break;case o.FLOAT_MAT3:o.uniformMatrix3fv(d,!1,t);break;case o.SAMPLER_2D:o.uniform1i(d,t);break;default:return void console.error('Attempt to set unknown uniform type: '+l);}}}},Engine.Shape={drawRectangle:function(e,t,n,o){let d=Engine.Canvas._.webgl;e+=Engine.Canvas._.drawOffset.x,t+=Engine.Canvas._.drawOffset.y;let l=new Float32Array([e,t+o,e,t,e+n,t+o,e+n,t]);Engine.Shape._.drawShape(l,d.TRIANGLE_STRIP)},drawTriangle:function(e,t,n,o,d,l){let _=Engine.Canvas._.webgl;e+=Engine.Canvas._.drawOffset.x,t+=Engine.Canvas._.drawOffset.y,n+=Engine.Canvas._.drawOffset.x,o+=Engine.Canvas._.drawOffset.y,d+=Engine.Canvas._.drawOffset.x,l+=Engine.Canvas._.drawOffset.y;let f=new Float32Array([e,t,n,o,d,l]);Engine.Shape._.drawShape(f,_.TRIANGLES)},setColorRGBA:function(e,t,n,o){Engine.Shape._.color.assign(e,t,n,o)},setColor:function(e){Engine.Shape._.color.copy(e)},_:{color:null,vbo:null,initialize:function(){Engine.Shape._.vbo=Engine.Canvas._.webgl.createBuffer(),Engine.Shape._.color=new Engine.Color},drawShape:function(e,t){let n=Engine.Assets.untextured;Engine.Shader.setCurrent(n);let o=Engine.Canvas._.webgl;o.bindBuffer(o.ARRAY_BUFFER,Engine.Shape._.vbo),o.bufferData(o.ARRAY_BUFFER,e,o.DYNAMIC_DRAW),n.enableAttribute('in_vert_pos',2,!1,0,0);let d=Engine.Canvas._.worldSpace.toFloat32Array(),l=Engine.Shape._.color.toArray();n.setUniform('world_space_matrix',d),n.setUniform('object_draw_color',l),o.drawArrays(t,0,e.length/2)}}},Engine.Texture=class{constructor(e){let t=Engine.Canvas._.webgl,n=t.createTexture(),o=t.TEXTURE_2D,d=t.RGBA,l=t.UNSIGNED_BYTE;t.bindTexture(o,n),t.texImage2D(o,0,d,d,l,e);let _=t.CLAMP_TO_EDGE,f=t.LINEAR_MIPMAP_LINEAR,m=t.LINEAR;t.texParameteri(o,t.TEXTURE_WRAP_S,_),t.texParameteri(o,t.TEXTURE_WRAP_T,_),t.texParameteri(o,t.TEXTURE_MIN_FILTER,f),t.texParameteri(o,t.TEXTURE_MAG_FILTER,m),t.generateMipmap(o);let u=t.createBuffer(),C=t.createBuffer();this._={},this._.texture=n,this._.width=e.width,this._.height=e.height,this._.anchor='center',this._.color=new Engine.Color,this._.vertexVBO=u,this._.texCoordVBO=C,this._.image=e}draw(e,t,n=1,o=1,d=0){let l=this._getAnchorPosition(this._.width,this._.height);this._draw(e,t,n,o,l.x,l.y,d,null,null)}drawClipped(e,t,n,o=1,d=1,l=0){let _=n.x/this._.width,f=n.y/this._.height,m=_+n.w/this._.width,u=f+n.h/this._.height,C=n.w,A=n.h,E=new Float32Array([0,A,0,0,C,A,C,0]),p=new Float32Array([_,u,_,f,m,u,m,f]),T=this._getAnchorPosition(n.w,n.h);this._draw(e,t,o,d,T.x,T.y,l,E,p)}drawAnimated(e,t,n,o=1,d=1,l=0){let _=n.getCurrentFrame();this.drawClipped(e,t,_,o,d,l)}setAnchor(e){this._.anchor=e}setColorRGBA(e,t,n,o){this._.color.assign(e,t,n,o)}setColor(e){this._.color=e}getWidth(){return this._.width}getHeight(){return this._.height}getAnchor(){return this._.anchor}_draw(e,t,n,o,d,l,_,f,m){let u=Engine.Assets.textured,C=Engine.Canvas._.webgl;e+=Engine.Canvas._.drawOffset.x,t+=Engine.Canvas._.drawOffset.y,Engine.Shader.setCurrent(u);let A=new Engine.Matrix3;A.assignTranslate(e,t),A.assignRotate(_),A.assignScale(n,o),A.assignTranslate(-d,-l);let E=Engine.Canvas._.worldSpace.toFloat32Array(),p=A.toFloat32Array(),T=this._.color.toArray();var v=this._.width,R=this._.height;f||(f=new Float32Array([0,R,0,0,v,R,v,0])),m||(m=new Float32Array([0,1,0,0,1,1,1,0]));let S=this._.texture,F=this._.vertexVBO,B=this._.texCoordVBO;C.bindBuffer(C.ARRAY_BUFFER,F),C.bufferData(C.ARRAY_BUFFER,f,C.DYNAMIC_DRAW),C.bindBuffer(C.ARRAY_BUFFER,B),C.bufferData(C.ARRAY_BUFFER,m,C.DYNAMIC_DRAW),C.bindBuffer(C.ARRAY_BUFFER,F),u.enableAttribute('in_vert_pos',2,!1,2,0),C.bindBuffer(C.ARRAY_BUFFER,B),u.enableAttribute('in_tex_coord',2,!0,2,0),u.setUniform('world_space_matrix',E),u.setUniform('object_space_matrix',p),u.setUniform('texture',0),u.setUniform('mod_color',T),C.activeTexture(C.TEXTURE0),C.bindTexture(C.TEXTURE_2D,S),C.drawArrays(C.TRIANGLE_STRIP,0,4)}_getAnchorPosition(e,t){switch(this._.anchor){case'top-left':return new Engine.Vector2(0,0);case'top-center':return new Engine.Vector2(e/2,0);case'top-right':return new Engine.Vector2(e,0);case'center-left':return new Engine.Vector2(0,t/2);case'center':return new Engine.Vector2(e/2,t/2);case'center-right':return new Engine.Vector2(e,t/2);case'bottom-left':return new Engine.Vector2(0,t);case'bottom-center':return new Engine.Vector2(e/2,t);case'bottom-right':return new Engine.Vector2(e,t);default:return console.error('Unknown texture anchor alignment!'),new Engine.Vector2;}}},Engine.Text={drawStroke:function(e,t,n){var o=Engine.Canvas._,d=n.split('\n');e+=o.drawOffset.x,t+=o.drawOffset.y;for(let l=0;l<d.length;l++){let _=Engine.Text._.size*l,f=d[l];o.text.strokeText(f,e,t+_)}},drawFill:function(e,t,n){var o=Engine.Canvas._,d=n.split('\n');e+=o.drawOffset.x,t+=o.drawOffset.y;for(let l=0;l<d.length;l++){let _=Engine.Text._.size*l,f=d[l];o.text.fillText(f,e,t+_)}},setFont:function(e){let t=Engine.Text._.size,n=`${t}px ${e}`;Engine.Canvas._.text.font=n,Engine.Text._.font=e},setSize:function(e){let t=Engine.Text._.font,n=`${e}px ${t}`;Engine.Canvas._.text.font=n,Engine.Text._.size=e},setAlignment:function(e){Engine.Canvas._.text.textAlign=e,Engine.Text._.alignment=e},setColorRGBA:function(e,t,n,o){let d=new Engine.Color(e,t,n,o);Engine.Text.setColor(d)},setColor:function(e){let t=255*e.r,n=255*e.g,o=255*e.b,d=`rgb(${t},${n},${o})`;Engine.Canvas._.text.strokeStyle=d,Engine.Canvas._.text.fillStyle=d,Engine.Canvas._.text.globalAlpha=e.a,Engine.Text._.color.copy(e)},setShadowColorRGBA:function(e,t,n,o){let d=new Engine.Color(e,t,n,o);Engine.Text.setShadowColor(d)},setShadowColor:function(e){let t=255*e.r,n=255*e.g,o=255*e.b,d=`rgba(${t},${n},${o},${e.a})`;Engine.Canvas._.text.shadowColor=d,Engine.Text._.shadowColor.copy(e)},setShadowBlur:function(e){Engine.Canvas._.text.shadowBlur=e,Engine.Text._.shadowBlur=e},setShadowOffset:function(e,t){Engine.Canvas._.text.shadowOffsetX=e,Engine.Canvas._.text.shadowOffsetY=t,Engine.Text._.shadowOffsetX=e,Engine.Text._.shadowOffsetY=t},getBounds:function(e){var t={width:0,height:0},n=e.split('\n');t.height=n.length*Engine.Text._.size;for(let d=0;d<n.length;d++){var o=Engine.Canvas._.text.measureText(n[d]).width;t.width<o&&(t.width=o)}return t},_:{font:null,size:null,alignment:null,color:null,shadowColor:null,shadowBlur:null,shadowOffsetX:null,shadowOffsetY:null,initialize:function(){Engine.Text._.font='sans-serif',Engine.Text._.size=32,Engine.Text._.alignment='start',Engine.Text._.color=new Engine.Color,Engine.Text._.shadowColor=new Engine.Color(0,0,0,0),Engine.Text._.shadowBlur=0,Engine.Text._.shadowOffsetX=0,Engine.Text._.shadoeOffsetY=0},restore:function(){Engine.Canvas._.text.textBaseline='top',Engine.Text.setFont(Engine.Text._.font),Engine.Text.setSize(Engine.Text._.size),Engine.Text.setAlignment(Engine.Text._.alignment),Engine.Text.setColor(Engine.Text._.color);let e=Engine.Text._.shadowOffsetX,t=Engine.Text._.shadowOffsetY;Engine.Text.setShadowColor(Engine.Text._.shadowColor),Engine.Text.setShadowBlur(Engine.Text._.shadowBlur),Engine.Text.setShadowOffset(e,t)}}},Engine.Animation=class{constructor(e){this._={},this._.frameWidth=e.frameSize.width,this._.frameHeight=e.frameSize.height,this._.startX=e.startOffset.x,this._.startY=e.startOffset.y,this._.frames=e.frames,this._.looped=e.looped,this._.paused=!1,this._.timer=0}update(e){if(!this._.paused&&(this._.timer+=e,this._.looped)){var t=this.getLength();if(0>=t)return;for(;this._.timer>=t;)this._.timer-=t}}pause(e){this._.paused=e}reset(){this._.timer=0}getCurrentFrame(){if(0===this._.frames.length)return null;var e=0,t=0;for(let o=0;o<this._.frames.length&&(e+=this._.frames[o],!(e>=this._.timer));o++)t++;t>=this._.frames.length&&(t=this._.frames.length-1);let n={x:this._.startX+t*this._.frameWidth,y:this._.startY,w:this._.frameWidth,h:this._.frameHeight};return n}getLength(){return this._.frames.reduce((e,t)=>e+t,0)}getFrameWidth(){return this._.frameWidth}getFrameHeight(){return this._.frameHeight}isLooped(){return this._.looped}isPaused(){return this._.paused}isDone(){return!this._.looped&&this._.timer>=this.getLength()}},Engine.Mixer={_:{context:null,initialize:function(){const e=window.AudioContext||window.webkitAudioContext;Engine.Mixer._.context=new e,'suspended'===Engine.Mixer._.context.state&&Engine.Mixer._.context.resume()}}},Engine.Sound=class{constructor(e){this._={},this._.buffer=e}play(){let e=Engine.Mixer._.context,t=e.createBufferSource();t.buffer=this._.buffer,t.connect(e.destination),t.start(0)}};
